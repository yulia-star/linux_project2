## Part 1. Инструмент ipcalc

ipclac 192.167.38.54/13 # узнать IP-адрес, маску подсети, broadcast и др. в десятиричной и двоичной системах

### 1.1. Сети и маски
Определить и записать в отчёт:
1) Адрес сети 192.167.38.54/13:
     Address: 192.167.38.54        11000000.10100 111.00100110.00110110
2) Перевод маски:
     255.255.255.0 в префиксную и двоичную запись - /24
     /15 в обычную и двоичную - 255.254.0.0
     11111111.11111111.11111111.11110000 в обычную и префиксную - /28
3) Минимальный и максимальный хост в сети 12.167.38.4 при масках:
     /8 - 192.0.0.1 - 192.255.255.254 (первый (192.0.0.0) и последний (192.255.255.255 - для broadcast) номера резервируются)
     11111111.11111111.00000000.00000000 - 192.167.0.1 - 192.167.255.254
     255.255.254.0 - 192.167.38.1 - 192.167.39.254
     /4 - 192.0.0.1 - 207.255.255.254

### 1.2. localhost
диапазон 127.0.0.1 - 127.255.255.254 используется только для локальных сетей
Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP:
```
  194.34.23.100 - нет
  127.0.0.2 - да
  127.1.0.1 - да
  128.0.0.1 - нет
```
### 1.3. Диапазоны и сегменты сетей
Публицные (белые) IP адреса - те, которые действуют в сети интернет
Приватные (серые) IP адреса - те, которые действуют в локальной сети (роутер раздает на устройства свои IP адреса,
которые не обращаются напрямую в интернет, а IP адрес роутера будет публичным)
```
Диапазоны приватных (частных, серых) подсетей:
10.0.0.0 — 10.255.255.255 (маска подсети для бесклассовой (CIDR) адресации: 255.0.0.0 или /8)
172.16.0.0 — 172.31.255.255 (маска подсети для бесклассовой (CIDR) адресации: 255.240.0.0 или /12)
192.168.0.0 — 192.168.255.255 (маска подсети для бесклассовой (CIDR) адресации: 255.255.0.0 или /16)
```
Определить и записать в отчёт:
1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных:
  10.0.0.45 - част
  134.43.0.2 - публ
  192.168.4.2 - част
  172.20.250.4 - част
  172.0.2.1 - публ
  192.172.0.1 - публ
  172.68.0.2 - публ
  172.16.255.255 - част
  10.10.10.10 - част
  192.169.168.1 - публ
2) какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:
  10.0.0.1 - да
  10.10.0.2 - да
  10.10.10.10 - да
  10.10.100.1 - нет
  10.10.1.255 - нет
  
  Для данной сети 10.10.0.0/18:
    HostMin: 10.10.0.1
    HostMax: 10.10.63.254
  Ответы, исходя их этого диапазона
  
## Part 2. Статическая маршрутизация между двумя машинами
ip a # просмотр ip адреса (то же самое, что ip addr)

Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски:
  ws1 - 192.168.100.10, маска /16
  ws2 - 172.24.116.8, маска /12
Изменяемый файл: etc/netplan/00-installer-config.yaml

### 2.1. Добавление статического маршрута вручную
Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add
Пропинговать соединение между машинами
В отчёт поместить скрин с вызовом и выводом использованных команд.

Мое выполнение:
  в VirtualBox на обеих ws зашла в настройки > Сеть > Адаптер 2 > Включить сетевой адаптер > Тип подключения: Внутренняя сеть
  это привело к тому, что на обеих ws появился интерфейс enp0s8
  
Далее вводим команду sudo route add:
```
ws1:
  sudo ip r add 172.24.116.8 via 192.168.100.10
  после этого при попытке пинга 172.24.116.8 соединения еще не будет
  ping 172.24.116.8
ws2:
  sudo ip r add 192.168.100.10 via 172.24.116.8
  после этого можно проверить пинг на обеих машинах, будет соединяться
  ping 192.168.100.10
```
Данная настройка будет сброшена при перезагрузке виртуальных машин

Теория:
Синтаксис добавления нового маршрута в таблицу маршрутизации такой:
  - ip route add подсеть/маска via шлюз
Вместо шлюза можно указать сетевой интерфейс с помощью которого надо отправлять пакеты:
  - ip route add подсеть/маска dev устройство
Например, добавим новый маршрут для сети через тот же IP адрес:
  sudo ip route add 169.255.0.0 via 169.254.19.153
Или можно указать сетевой интерфейс через который надо отправлять пакеты для определённой сети:
  sudo ip route add 169.255.0.0 dev enp0s3

### 2.2. Добавление статического маршрута с сохранением
Перезапустить машины
Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml
В отчёт поместить скрин с содержанием изменённого файла etc/netplan/00-installer-config.yaml.
Пропинговать соединение между машинами

На обеих ws внесла изменения в файл etc/netplan/00-installer-config.yaml (разница только в ip):
```
ws1:
# This is the network config written by 'sibiquity'
network:
  ethernets:
    enp0s8:
      dhcp4: false
      addresses: [192.168.100.10/16]
      nameservers:
        addresses: [8.8.8.8, 1.1.1.1]
      routes:
          - to: 172.24.116.8
            via: 192.168.100.10
    enp0s3:
      dhcp4: true
   version: 2
```
```
ws2:
# This is the network config written by 'sibiquity'
network:
  ethernets:
    enp0s8:
      dhcp4: false
      addresses: [172.24.116.8/12]
      nameservers:
        addresses: [8.8.8.8, 1.1.1.1]
      routes:
          - to: 192.168.100.10
            via: 172.24.116.8
    enp0s3:
      dhcp4: true
   version: 2
```
Далее для каждой машины выполнена команда для того, чтобы ip интерфейса применился:
  sudo netplan apply

Проверяем изменения одной из команд:
  ip a, ip addr, ifconfig
  
Далее вводим пингуем обе машины:
ws1:
  ping 172.24.116.8
ws2:
  ping 192.168.100.10

После перезагрузки виртуальных соединение сохраняется, то есть можно сразу проверить ping

## Part 3. Утилита iperf3
### 3.1. Скорость соединения
Перевести и записать в отчёт:
  8 Mbps в MB/s = 1MB/s (Mbps (мегабит в секунду), MB/s (мегабайт в секунду). Основание перевода величин: 1 Mbps = 0.125 MB/s)
  100 MB/s в Kbps = 8 Mbps * 100 * 1000 = 800 000 Kbps (1 Mbps = 1000 kbps (килобит в секунду))
  1 Gbps в Mbps = 125 * 8 = 1000 Mbps (1 Gbps = 125 MB/s)

### 3.2. Утилита iperf3
Измерить скорость соединения между ws1 и ws2

ws1 определили как сервер командой:
  iperf3 -s
  
ws2 определили клиентом командой, иметь ввиду, что указан ip сервера:
  iperf3 -c 192.168.100.10
  
После этого на обеих машинах пошли соединения.
Bitrate в среднем:
  ws1: 748 Mbits/sec
  ws2: 718 Mbits/sec
  
## Part 4. Сетевой экран
### 4.1. Утилита iptables

iptable - это firewall, то есть межсетевой экран.
Firewall состоит цепочек, а они в свою очередь из таблиц.
```
Цепочки:

* Prerouting
* Input
* Output
* Postrouting
* Forward
```
__Есть 2 пути, по котору идут пакеты:__
1. Prerouting > Input > Преобразование в приложении > Output > Postroting
2. Prerouting > Forward > Postrouting

В каждой цепочке есть свои таблицы:
* nat - таблица для преобразования сетевых адресов
* filter (таблица по умолчанию, в нее записываются все правила, если таблица не указана явно) - в таблице прописываются правила DROP, REJECT, ACCEPT для определенных IP-адресов, портов и т.д.
* raw (задается маркировка пакета, для которого не требуются дальнейшие изменения)
* mangle (в таблице задается TTL - time to life, то есть время жизни пакета, если он не находит ответа)
* Connection (stale) Tracking (определение состояний conntrack) - определяет состояние пакета (new, esteblished, invalid или relaited) и на основании этого состояния делаются какие-то действия

![iptables](https://forum.nag.ru/uploads/monthly_2020_04/cbfruui7ydb8lqm19myzozfotbo.png.29639c65a69273e1361e6d985687a210.png)

__Команды:__
1. iptables -L
2. iptables -L -t nat # задать таблицу явно
3. iptables -L -v # вывод в более подробном виде
4. iptables –F # очистка таблиц (по умолчанию очистит таблицу filter, для очистки другой таблицы ее нужно явно задать iptables -F -t nat)
5. iptables -X # очистка таблиц (по умолчанию очистит таблицу filter, для очистки другой таблицы ее нужно явно задать iptables -X -t nat)

Политика по умолчанию (policy ACCEPT или policy DROP или policy REJECT)

6. iptables -P INPUT DROP # изменение политики по умолчанию в цепочке INPUT на DROP (по умолчанию в таблицу filter)

если поставить политику по умолчанию DROP, то не только другие компьютеры не смогут отправлять нам пакеты, но и наш компьютер не сможет отправить пакеты, поэтому нужно ввести правило:
7. iptables -A INPUT conntrack --ctstate RELATED, ESTABLISHED -j ACCEPT # таким образом наш компьютер сможет отправить пакеты, а другие компьютеры к нам - не смогут (проверяем ping-ом)

также при политике по умолчанию DROP обязательно нужно разрешить доступ для самого себя - lo (локального интерфейса - 127.0.0.1):
8. iptables -A INPUT -i lo -j ACCEPT
9. iptables -D INPUT -i lo -j ACCEPT # удаление правила
10. iptables -A INPUT -i enp0s8 -m tcp -p tcp --dport 80 -j ACCEPT # правило, разрешающее по протоколу tcp accept на порт 80 (с другой машины можно будет подключиться по этому порту)
11. iptables -A INPUT -i enp0s8 -m multiport -p tcp --dports 80:8080 -j ACCEPT # правило, разрешающее по протоколу tcp accept на порты с 80 по 8080
12. iptables -A INPUT -i enp0s8 -s 192.168.20.0/24 -m tcp -p tcp --dport 80 -j ACCEPT # дать доступ для определенной подсети и порта, то есть наши пакеты сможет получить только компьютеры из подсети 192.168.20.0/24 (весь диапазон адресов с 1 по 254) с порта 80

__nat__
  a. доступ из интернета к компьютерам локальной сети
  b. доступ из локальной сети в интернет с динамическим IP-адресом
  c. доступ из локальной сети в интернет со статическим IP-адресом

nat не будет работать, если не включен forwarding:
 * nano /etc/sysctl.conf (данные конфигурации будут применяться при каждой загрузке) >
 раскомментировать строку net.ipv4.tcp_syncookies=1 >
 перезагрузиться (либо без перезагрузки echo 1 > /proc/sys/net/ipv4/ip_forward # не сохраняется при перезагрузке)

__Доступ из локальной сети в интернет с динамическим IP-адресом:__
Для этого на компьютере, который имеет доступ в интернет пишем команду:
13. iptables -A POSTROUTING -t nat -s 192.168.20.0/24 -o enp0s3 -j MASQUERADE # подсеть компьютера без доступа в интернет, интерфейс, который смотрит в сторону интернета (после этого у компьютера можно проверить ping)

```
MASQUERADE применяется в работе с динамическим IP-адресом и использует дополнительные ресурсы компьютера для постоянного сопоставления IP-адресов.
Если на компьютере статический IP-адрес, то нужно использовать SNAT для экономии ресурсов компьютера.
```

__Доступ из локальной сети в интернет со статическим IP-адресом:__
14. iptables -A POSTROUTING -t nat -s 192.168.20.0/24 -o enp0s3 -j SNAT --to-source 192.168.1.223 # 192.168.1.223 - IP текущего сетевого интерфейса enp0s3 (на этом компьютере с доступом в интернет)

```
если не работает ping в браузере или к терминале, нужно отключить и снова включить сетевой интерфейс, смотрящий в интернет:

ifconfig enp0s3 down
ifconfig enp0s3 up

и точно так же для компьютера в локальной сети - выключить и включить
```
__Доступ из интернета к компьютерам локальной сети:__
15. iptables -A PREROUTING -t nat -i enp0s3 -p tcp --dport 900 -j DNAT --to-destination 192.168.20.2

__Все полученные правила нужно сохранить, чтобы они работали после перезагрузки__
16. iptables-save > /root/iptables-rules

__Восстановить удаленные правила во всех таблицах iptables:__
17. iptables-restore < /root/iptables-rules

__Чтобы все правила iptables устанавливались при загрузке системы:__
18. nano /etc/network/interfaces # файл для настройки сетевых интерфейсов (скорее всего netplan)
и в файле пишем:
```
pre-up iptables-restore < /root/iptables-rules
```

Создать файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2:
```
#!/bin/sh

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables –F
iptables -X
```

Нужно добавить в файл подряд следующие правила:
1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
5) разрешить echo reply (машина должна "пинговаться")
В отчёт поместить скрины с содержанием файла /etc/firewall для каждой машины.
Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh
В отчёт поместить скрины с запуском обоих файлов.
В отчёте описать разницу между стратегиями, применёнными в первом и втором файлах.

### 4.2. Утилита nmap
Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен
Проверка: в выводе nmap должно быть сказано: Host is up

В отчёт поместить скрины с вызовом и выводом использованных команд ping и nmap.
Сохранить дампы образов виртуальных машин
p.s. Ни в коем случае не сохранять дампы в гит!
